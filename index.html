<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR Racetrack in A-Frame</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://rawgit.com/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"></script>
    <style>
      .a-enter-vr, .a-enter-ar {
        position: fixed !important;
        bottom: 20px !important;
        transform: translateX(-50%) !important;
      }

      .a-enter-vr {
        left: 50% !important;
      }

      .a-enter-ar {
        left: 35% !important;
      }
    </style>
  </head>
  <body>
    <a-scene embedded arjs>
      <a-assets>
        <a-asset-item id="track" src="racing_track.gltf"></a-asset-item>
      </a-assets>

      <a-light type="ambient" intensity="0.5"></a-light>
      <a-light type="directional" position="2 5 3" intensity="0.8"></a-light>

      <!-- Define 4 ArUco marker trackers -->
      <a-marker id="marker0" type="barcode" value="0"></a-marker>
      <a-marker id="marker1" type="barcode" value="1"></a-marker>
      <a-marker id="marker2" type="barcode" value="2"></a-marker>
      <a-marker id="marker3" type="barcode" value="3"></a-marker>

      <!-- Racetrack that will be dynamically positioned -->
      <a-entity id="racetrack" gltf-model="#track" scale="0.5 0.5 0.5"></a-entity>

      <a-camera position="0 0 0"></a-camera>
    </a-scene>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let markers = {
          0: null,
          1: null,
          2: null,
          3: null
        };

        function updateTrackPosition() {
          let markerPositions = Object.values(markers).filter(pos => pos !== null);
          
          if (markerPositions.length === 4) {
            let avgX = markerPositions.reduce((sum, p) => sum + p.x, 0) / 4;
            let avgY = markerPositions.reduce((sum, p) => sum + p.y, 0) / 4;
            let avgZ = markerPositions.reduce((sum, p) => sum + p.z, 0) / 4;

            let racetrack = document.querySelector("#racetrack");
            racetrack.setAttribute("position", `${avgX} ${avgY} ${avgZ}`);
          }
        }

        function setupMarkerListener(markerId) {
          let marker = document.querySelector(`#marker${markerId}`);
          marker.addEventListener("markerFound", function () {
            let position = marker.object3D.position;
            markers[markerId] = { x: position.x, y: position.y, z: position.z };
            updateTrackPosition();
          });

          marker.addEventListener("markerLost", function () {
            markers[markerId] = null;
          });
        }

        setupMarkerListener(0);
        setupMarkerListener(1);
        setupMarkerListener(2);
        setupMarkerListener(3);
      });
    </script>
  </body>
</html>
